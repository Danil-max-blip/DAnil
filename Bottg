import asyncio
import logging
from aiogram import Bot, Dispatcher, types
from aiogram.filters import Command
from openai import AsyncOpenAI

TELEGRAM_TOKEN = "–í–ê–®_–¢–û–ö–ï–ù"
OPENAI_API_KEY = "–ú–û–î–ï–õ–¨_–ê–ò–®–ö–ò"
OPENAI_BASE_URL = "–ó–ï–†–ö–ê–õ–û –î–õ–Ø –û–ë–•–û–î–ê –ë–õ–û–ö–ò–†–û–í–ö–ò –í –†–§"

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
bot = Bot(token=TELEGRAM_TOKEN)
dp = Dispatcher()
client = AsyncOpenAI(
    api_key=OPENAI_API_KEY,
    base_url=OPENAI_BASE_URL
)

SYSTEM_PROMPT = (
    "You are a friendly and professional English tutor. "
    "Your goal is to chat with the user to improve their language skills. "
    "Follow these rules:\n"
    "1. If the user makes a grammar, spelling, or stylistic mistake, point it out gently.\n"
    "2. Explain why it's a mistake in a short and simple way.\n"
    "3. Provide the corrected version of their sentence.\n"
    "4. Then, continue the conversation by answering their message or asking a follow-up question.\n"
    "5. Use a friendly tone. If the user is a beginner, use simple English."
)

user_histories = {}

async def get_ai_response(user_id, user_text):
    if user_id not in user_histories:
        user_histories[user_id] = [{"role": "system", "content": SYSTEM_PROMPT}]

    user_histories[user_id].append({"role": "user", "content": user_text})

    free_models = [
        "upstage/solar-pro-3:free",
    ]

    ai_answer = None
    last_error = ""

    for model_id in free_models:
        try:
            logging.info(f"–ü—Ä–æ–±—É—é –º–æ–¥–µ–ª—å: {model_id}")
            response = await client.chat.completions.create(
                model=model_id,
                messages=user_histories[user_id],
                timeout=25.0
            )
            ai_answer = response.choices[0].message.content
            if ai_answer:
                logging.info(f"–£—Å–ø–µ—à–Ω–æ –æ—Ç–≤–µ—Ç–∏–ª–∞ –º–æ–¥–µ–ª—å: {model_id}")
                break
        except Exception as e:
            last_error = str(e)
            logging.warning(f"–ú–æ–¥–µ–ª—å {model_id} –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∞: {e}")
            continue
    if not ai_answer:
        raise Exception(f"–í—Å–µ –º–æ–¥–µ–ª–∏ —Å–µ–π—á–∞—Å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã. –ü–æ—Å–ª–µ–¥–Ω—è—è –æ—à–∏–±–∫–∞: {last_error}")

    user_histories[user_id].append({"role": "assistant", "content": ai_answer})

    if len(user_histories[user_id]) > 10:
        user_histories[user_id] = [user_histories[user_id][0]] + user_histories[user_id][-9:]

    return ai_answer

@dp.message(Command("start"))
async def start_handler(message: types.Message):
    user_histories[message.from_user.id] = [{"role": "system", "content": SYSTEM_PROMPT}]
    await message.answer(
        "Hello! I'm your AI English Tutor. üá¨üáß\n"
        "Send me any message in English. I will correct your mistakes and keep the conversation going!"
    )

@dp.message(Command("reset"))
async def reset_handler(message: types.Message):
    user_histories[message.from_user.id] = [{"role": "system", "content": SYSTEM_PROMPT}]
    await message.answer("Our conversation history has been reset. Let's start over!")

@dp.message()
async def message_handler(message: types.Message):
    await bot.send_chat_action(message.chat.id, action="typing")

    try:
        answer = await get_ai_response(message.from_user.id, message.text)
        await message.answer(answer)
    except Exception as e:
        logging.error(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")
        await message.answer("Sorry, all free AI servers are busy right now. üò≠ Please try again in 5-10 minutes.")

async def main():
    logging.basicConfig(level=logging.INFO)
    print("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ –≥–æ—Ç–æ–≤ —É—á–∏—Ç—å –∞–Ω–≥–ª–∏–π—Å–∫–æ–º—É!")
    await dp.start_polling(bot)

# –ó–∞–ø—É—Å–∫ –ø—Ä–æ–≥—Ä–∞–º–º—ã
if __name__ == "__main__":
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        print("–ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º")
